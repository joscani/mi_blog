---
title: Cocinando
author: jlcr
date: '2022-01-01'
slug: cocinando
categories:
  - muestreo
tags:
  - estadística
  - raking
description: ''
topics: []
---

<script src="/rmarkdown-libs/header-attrs/header-attrs.js"></script>
<script src="/rmarkdown-libs/htmlwidgets/htmlwidgets.js"></script>
<link href="/rmarkdown-libs/datatables-css/datatables-crosstalk.css" rel="stylesheet" />
<script src="/rmarkdown-libs/datatables-binding/datatables.js"></script>
<script src="/rmarkdown-libs/jquery/jquery-3.6.0.min.js"></script>
<link href="/rmarkdown-libs/dt-core/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="/rmarkdown-libs/dt-core/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="/rmarkdown-libs/dt-core/js/jquery.dataTables.min.js"></script>
<link href="/rmarkdown-libs/crosstalk/css/crosstalk.min.css" rel="stylesheet" />
<script src="/rmarkdown-libs/crosstalk/js/crosstalk.min.js"></script>


<p>Lo primero, feliz año a todos (no me da la gana de poner todas y todes), y espero que este año sea mejor que el pasado.</p>
<p>Hoy voy a hablar un poco de la “cocina” electoral en los barómetros de opinión, pero de forma muy simplificada.</p>
<p>Una de las primeras cosas que se hacía era comparar el recuerdo de voto declarado en la encuesta con el resultado real de las elecciones a las que hacía referencia.</p>
<p>Cuándo no coinciden una de las cosas que se hacían era imputar el recuerdo de voto para aquellos que no contestaron a la pregunta. Esto se hacía utilizando variables de la encuesta, típicamente variables de autoposición idelógica y similares.</p>
<p>Una vez imputado el recuerdo de voto se comparaba de nuevo con el resultado real de las elecciones y si variaba se recurría a la ponderación por el recuerdo de voto real. Esto es, se estimaban unos pesos de forma que la distribución del recuerdo de voto en la encuesta fuera lo más similar posible a los resultados reales.</p>
<p>Esta “reponderación” corre el riesgo de descalibrar la encuesta en otras variables, tales como sexo y edad, por poner un ejemplo. La solución podría ser postestratificar la muestra, pero para eso deberíamos saber los valores poblaciones en cada combinación de sexo, edad (posiblemente agrupada) y recuerdo de voto. Es decir, tener la distribución conjunta, lo cual implica tener por ejemplo todas las combinaciones de edad y partido al que votó en la muestra y también saber la distribución poblacional (en las elecciones consideradas). Evidentemente no siempre es posible tener tanta información, por lo que se opta por al menos ajustar las distribuciones marginales.</p>
<p>Para obtener esos pasos se utiliza un procedimiento iterativo llamado <a href="https://www.tandfonline.com/doi/abs/10.1080/01621459.1992.10475217"><code>raking</code></a></p>
<p>Para ver como se haría esa parte de la “cocina” (lo de imputar los nulos en recuerdo de voto usando un modelo no lo voy a hacer), utilizando la librería <a href="http://r-survey.r-forge.r-project.org/svybook/"><code>survey</code></a> de Thomas Lumley.</p>
<div id="fuentes-de-datos." class="section level2">
<h2>Fuentes de datos.</h2>
<ul>
<li><p><a href="http://www.cis.es/cis/opencm/ES/1_encuestas/estudios/ver.jsp?estudio=14595">Barómetro del CIS, noviembre de 2021.</a></p></li>
<li><p><a href="http://www.infoelectoral.mir.es/">Resultados electorales oficiales</a> utilizando la fantástica librería <a href="https://github.com/rOpenSpain/infoelectoral"><code>infoelectoral</code></a></p></li>
<li><p>Padrón oficial de habitantes a 1 de Enero de 2020.</p></li>
</ul>
</div>
<div id="obtención-datos" class="section level2">
<h2>Obtención datos</h2>
<div id="encuesta-cis." class="section level3">
<h3>Encuesta CIS.</h3>
<pre class="r"><code>library(tidyverse)</code></pre>
<pre><code>## ── Attaching packages ────────────────────────────────── tidyverse 1.3.1.9000 ──</code></pre>
<pre><code>## ✓ ggplot2 3.3.5     ✓ purrr   0.3.4
## ✓ tibble  3.1.6     ✓ dplyr   1.0.7
## ✓ tidyr   1.1.4     ✓ stringr 1.4.0
## ✓ readr   2.1.1     ✓ forcats 0.5.1</code></pre>
<pre><code>## ── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
## x dplyr::filter() masks stats::filter()
## x dplyr::lag()    masks stats::lag()</code></pre>
<pre class="r"><code>library(infoelectoral)
library(magrittr) # </code></pre>
<pre><code>## 
## Attaching package: &#39;magrittr&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:purrr&#39;:
## 
##     set_names</code></pre>
<pre><code>## The following object is masked from &#39;package:tidyr&#39;:
## 
##     extract</code></pre>
<pre class="r"><code>library(patchwork) #
 
df &lt;- haven::read_sav(&quot;/home/jose/Rstudio_projects/raking_ejemplo/MD3340/3340.sav&quot;)
df %&lt;&gt;%  ## change in place
  rename_all(tolower)


# Convierto a factor algunas variables para que pillen el label que 
# viene del fichero de spss. 

df &lt;- df %&gt;% 
  mutate(across(.cols = c(ccaa, sexo, recuerdo, recuvotogr, 
                          intenciongalter, intenciong, intenciongr, 
                          intenciongalterr), .fns = as_factor))

# categorizmaos la edad
df &lt;- df %&gt;%
  mutate(
    gedad =
      case_when(
        edad &gt;= 100 ~ &quot;100 años y más&quot;,
        edad &gt;= 18 &amp; edad &lt;= 24 ~ &quot;18-24 años&quot;,
        edad &gt;= 25 &amp; edad &lt;= 29 ~ &quot;25-29 años&quot;,
        edad &gt;= 30 &amp; edad &lt;= 34 ~ &quot;30-34 años&quot;,
        edad &gt;= 35 &amp; edad &lt;= 39 ~ &quot;35-39 años&quot;,
        edad &gt;= 40 &amp; edad &lt;= 44 ~ &quot;40-44 años&quot;,
        edad &gt;= 45 &amp; edad &lt;= 49 ~ &quot;45-49 años&quot;,
        edad &gt;= 50 &amp; edad &lt;= 54 ~ &quot;50-54 años&quot;,
        edad &gt;= 55 &amp; edad &lt;= 59 ~ &quot;55-59 años&quot;,
        edad &gt;= 60 &amp; edad &lt;= 64 ~ &quot;60-64 años&quot;,
        edad &gt;= 65 &amp; edad &lt;= 69 ~ &quot;65-69 años&quot;,
        edad &gt;= 70 &amp; edad &lt;= 74 ~ &quot;70-74 años&quot;,
        edad &gt;= 75 &amp; edad &lt;= 79 ~ &quot;75-79 años&quot;,
        edad &gt;= 80 &amp; edad &lt;= 84 ~ &quot;80-84 años&quot;,
        edad &gt;= 85 &amp; edad &lt;= 89 ~ &quot;85-89 años&quot;,
        edad &gt;= 90 &amp; edad &lt;= 94 ~ &quot;90-94 años&quot;,
        edad &gt;= 95 &amp; edad &lt;= 99 ~ &quot;95-99 años&quot;,
       
      )
  )


df$gedad &lt;- as.factor(df$gedad)
head(df)</code></pre>
<pre><code>## # A tibble: 6 × 254
##       estudio registro  cues  tipo_tel ccaa       prov       mun  tamuni  entrev
##     &lt;dbl+lbl&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl+lbl&gt; &lt;fct&gt;  &lt;dbl+lb&gt; &lt;dbl+lbl&gt; &lt;dbl+l&gt; &lt;dbl+l&gt;
## 1 3340 [3340]     3982     1 2 [Móvil] Andal… 4 [Alme…  0 [Mun.… 1 [Men… 0 [Ano…
## 2 3340 [3340]     8979     2 2 [Móvil] Andal… 4 [Alme…  0 [Mun.… 3 [10.… 0 [Ano…
## 3 3340 [3340]    11104     3 2 [Móvil] Andal… 4 [Alme…  0 [Mun.… 3 [10.… 0 [Ano…
## 4 3340 [3340]     4205     4 2 [Móvil] Andal… 4 [Alme…  0 [Mun.… 3 [10.… 0 [Ano…
## 5 3340 [3340]     1191     5 1 [Fijo]  Andal… 4 [Alme… 13 [Alme… 5 [100… 0 [Ano…
## 6 3340 [3340]     1203     6 2 [Móvil] Andal… 4 [Alme… 13 [Alme… 5 [100… 0 [Ano…
## # … with 245 more variables: capital &lt;dbl+lbl&gt;, sexo &lt;fct&gt;, edad &lt;dbl+lbl&gt;,
## #   p0 &lt;dbl+lbl&gt;, p1 &lt;dbl+lbl&gt;, p2 &lt;dbl+lbl&gt;, p3 &lt;dbl+lbl&gt;, p3_1_1 &lt;dbl+lbl&gt;,
## #   p3_1_2 &lt;dbl+lbl&gt;, p3_1_3 &lt;dbl+lbl&gt;, p3_1_4 &lt;dbl+lbl&gt;, p3_1_5 &lt;dbl+lbl&gt;,
## #   p3_1_6 &lt;dbl+lbl&gt;, p4 &lt;dbl+lbl&gt;, sersanientre &lt;dbl+lbl&gt;, p4anno &lt;dbl+lbl&gt;,
## #   p4mes &lt;dbl+lbl&gt;, p4a0_1_20 &lt;dbl+lbl&gt;, p4a0_2_21 &lt;dbl+lbl&gt;,
## #   servientre_1 &lt;dbl+lbl&gt;, servientre_2 &lt;dbl+lbl&gt;, servientre_3 &lt;dbl+lbl&gt;,
## #   servientre_4 &lt;dbl+lbl&gt;, servientre_5 &lt;dbl+lbl&gt;, servientre_7 &lt;dbl+lbl&gt;, …</code></pre>
<p>Podemos ver cuántos encuestados hay por cada sexo,edad, y recuerdo de voto, contando los datos brutos o los datos utilizando la ponderación que ha calculado el CIS.</p>
<pre class="r"><code>df %&gt;% 
  group_by(sexo, gedad, recuerdo) %&gt;% 
  summarise(total = n(),
            peso_tot = sum(peso))</code></pre>
<pre><code>## `summarise()` has grouped output by &#39;sexo&#39;, &#39;gedad&#39;. You can override using the `.groups` argument.</code></pre>
<pre><code>## # A tibble: 509 × 5
## # Groups:   sexo, gedad [31]
##    sexo   gedad      recuerdo       total peso_tot
##    &lt;fct&gt;  &lt;fct&gt;      &lt;fct&gt;          &lt;int&gt;    &lt;dbl&gt;
##  1 Hombre 18-24 años PP                 7    6.82 
##  2 Hombre 18-24 años PSOE              17   18.1  
##  3 Hombre 18-24 años C&#39;s                2    2.11 
##  4 Hombre 18-24 años En Comú Podem      4    4.10 
##  5 Hombre 18-24 años Més Compromís      1    1.03 
##  6 Hombre 18-24 años EAJ-PNV            2    2.06 
##  7 Hombre 18-24 años Na+                1    0.563
##  8 Hombre 18-24 años VOX                4    4.13 
##  9 Hombre 18-24 años Unidas Podemos    13   13.7  
## 10 Hombre 18-24 años BNG                2    2.05 
## # … with 499 more rows</code></pre>
<p>Para normalizar las siglas usamos otra tabla de <code>lookup</code></p>
<pre class="r"><code>siglas_cis &lt;-  read_csv(&quot;/home/jose/Rstudio_projects/raking_ejemplo/siglas_cis.csv&quot;)</code></pre>
<pre><code>## Rows: 28 Columns: 2</code></pre>
<pre><code>## ── Column specification ────────────────────────────────────────────────────────
## Delimiter: &quot;,&quot;
## chr (2): recuerdo, key</code></pre>
<pre><code>## 
## ℹ Use `spec()` to retrieve the full column specification for this data.
## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
<pre class="r"><code>siglas_cis</code></pre>
<pre><code>## # A tibble: 28 × 2
##    recuerdo       key       
##    &lt;chr&gt;          &lt;chr&gt;     
##  1 No recuerda    abstencion
##  2 No votó        abstencion
##  3 C&#39;s            CIUDADANOS
##  4 PSOE           PSOE      
##  5 PP             PP        
##  6 N.C.           abstencion
##  7 VOX            VOX       
##  8 En blanco      abstencion
##  9 Unidas Podemos PODEMOS-IU
## 10 PACMA          PACMA     
## # … with 18 more rows</code></pre>
<pre class="r"><code># le pegamos las siglas normalizadas
df &lt;- df %&gt;% 
  left_join(siglas_cis) </code></pre>
<pre><code>## Joining, by = &quot;recuerdo&quot;</code></pre>
<pre class="r"><code># Vemos los totales por recuerdo de voto , usando la ponderacińo del cis
df %&gt;% 
  group_by(key) %&gt;% 
  summarise(frq = sum(peso))</code></pre>
<pre><code>## # A tibble: 16 × 2
##    key           frq
##    &lt;chr&gt;       &lt;dbl&gt;
##  1 abstencion 1064. 
##  2 BILDU        21.5
##  3 BNG          23.6
##  4 CIUDADANOS  239. 
##  5 COMPROMIS    22.1
##  6 CUP          17.4
##  7 ERC          81.9
##  8 JXCAT        40.0
##  9 MAS PAIS     28.7
## 10 OTROS        62.4
## 11 PACMA        26.4
## 12 PNV          40.5
## 13 PODEMOS-IU  426. 
## 14 PP          525. 
## 15 PSOE        917. 
## 16 VOX         244.</code></pre>
<pre class="r"><code># Vemos total de datos en la encuesta y comprobamos que la suma de las 
# ponderaciones coincide con el total de encuestados. 

df %&gt;% 
  summarise(n(), 
            sum(peso))</code></pre>
<pre><code>## # A tibble: 1 × 2
##   `n()` `sum(peso)`
##   &lt;int&gt;       &lt;dbl&gt;
## 1  3779       3779.</code></pre>
<pre class="r"><code># Convertimos a factor la variable con el recuerdo de voto normalizado
df$key &lt;- as.factor(df$key)</code></pre>
<p>Ahora lo que nos hace falta es saber los totales de recuerdo de voto, sexo y edad que debería haber tenido la encuesta.</p>
</div>
<div id="resultados-electorales" class="section level3">
<h3>Resultados electorales</h3>
<pre class="r"><code>congress_2019 &lt;- municipios(tipo_eleccion = &quot;congreso&quot;, anno = 2019, mes = &quot;11&quot;)

(votos_summary &lt;-  congress_2019 %&gt;%
  group_by(codigo_ccaa, codigo_provincia,
           codigo_municipio, municipio) %&gt;%
  summarise(
    abstencion = first(censo_ine) -
      first(votos_blancos) -
      first(votos_nulos) -
      first(votos_candidaturas),
    censo_ine = first(censo_ine), 
    votos_blancos = first(votos_blancos),
    votos_nulos = first(votos_nulos),
    votos_candidaturas = first(votos_candidaturas)  ) %&gt;%
    ungroup() %&gt;% 
  summarise(
    abstencion = sum(abstencion, na.rm = TRUE) +
      sum(votos_blancos, na.rm = TRUE) + 
      sum(votos_nulos, na.rm = TRUE),
    censo_ine = sum(censo_ine, na.rm = TRUE), 
    votos_blancos = sum(votos_blancos, na.rm = TRUE),
    votos_nulos = sum(votos_nulos, na.rm = TRUE),
    votos_candidaturas = sum(votos_candidaturas, na.rm = TRUE)
  ))</code></pre>
<pre><code>## `summarise()` has grouped output by &#39;codigo_ccaa&#39;, &#39;codigo_provincia&#39;, &#39;codigo_municipio&#39;. You can override using the `.groups` argument.</code></pre>
<pre><code>## # A tibble: 1 × 5
##   abstencion censo_ine votos_blancos votos_nulos votos_candidaturas
##        &lt;dbl&gt;     &lt;dbl&gt;         &lt;dbl&gt;       &lt;dbl&gt;              &lt;dbl&gt;
## 1   10973466  34870481        216249      248543           23897015</code></pre>
<pre class="r"><code># ponemos abstencion como partido
abstencion &lt;-  votos_summary %&gt;%
  select( abstencion) %&gt;%
  mutate(siglas = &quot;abstencion&quot;, 
         denominacion = &quot;abstencion&quot;, 
         codigo_partido = &quot;abstencion&quot;) %&gt;%  
  rename(votos = abstencion)




votos_partidos &lt;-  congress_2019 %&gt;% 
  group_by(codigo_partido, siglas, denominacion) %&gt;% 
  summarise(votos = sum(votos))</code></pre>
<pre><code>## `summarise()` has grouped output by &#39;codigo_partido&#39;, &#39;siglas&#39;. You can override using the `.groups` argument.</code></pre>
<pre class="r"><code>votos_final &lt;- votos_partidos %&gt;% 
  bind_rows(abstencion) %&gt;% 
  bind_cols(votos_summary %&gt;% 
               select( censo_ine)) %&gt;% # debe ser pob &gt; = 18 
  ungroup() %&gt;%
    mutate(prop_voto = votos/censo_ine) %&gt;% 
  arrange(-prop_voto) 
  

DT::datatable(votos_final)</code></pre>
<div id="htmlwidget-1" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-1">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50","51","52","53","54","55","56","57","58","59","60","61","62","63","64","65","66","67","68","69","70","71","72","73","74","75","76","77","78","79","80","81","82","83","84","85","86","87","88","89","90","91","92","93","94","95","96","97","98","99","100","101","102","103","104","105","106","107","108"],["abstencion","000094","000083","000116","000018","000078","000031","000090","000081","000028","000041","000091","000022","000076","000029","000046","000020","000085","000092","000019","000055","000074","000077","000048","000086","000010","000053","000082","000075","000013","000088","000093","000044","000080","000054","000043","000056","000101","000051","000098","000108","000049","000084","000009","000079","000037","000050","000113","000057","000102","000017","000045","000064","000061","000032","000117","000023","000058","000114","000072","000038","000006","000096","000110","000106","000040","000007","000063","000060","000002","000016","000015","000097","000087","000034","000068","000067","000095","000059","000073","000111","000042","000099","000089","000003","000047","000066","000025","000100","000035","000005","000024","000012","000112","000036","000008","000065","000030","000105","000014","000103","000021","000062","000039","000115","000011","000109",null],["abstencion","PSOE","PP","VOX","Cs","PODEMOS-IU","ERC-SOBIRANISTES","PSC-PSOE","PODEMOS-IU LV CA","ECP-GUANYEM","JxCAT-JUNTS","PSdeG-PSOE","EAJ-PNV","PODEMOS-EUPV","EH Bildu","MÁS PAÍS-EQ","CUP-PR","PP","PSE-EE (PSOE)","Cs","PACMA","PODEMOS-EU","PODEMOS-IU","MÉS COMPROM","PP-FORO","BNG","NA+","PODEMOS-IX","PODEMOS-EUIB","CCa-PNC-NC","PRC","PSOE","MÁS PAÍS-AN","PODEMOS-IU-BATZARRE","NC-CCa-PNC","MÁS PAÍS","PACMA","RECORTES CERO-GV","M PAÍS-CHA-","PUM+J","¡TERUEL EXI","MÉS-ESQUERR","PP","AxSÍ","PODEMOS-IU-","GBAI","M PAÍS","UPL","PCOE","RECORTES CERO-GV-PCAS-TC","CpM","MÁS PAÍS-CA","PCTE","PCPE","ERPV","XAV","EB","PCPA","VERDES","PH","I.Fem","AVANT ADELANTE LOS VERDES","PUM+J","UIG-SOM-CUIDES","SOMOS REGIÓ","IZQP","AVANT ADELANTE LOS VERDES","PCTC","PCPC","AHORA CANARIAS","CONTIGO","CHA","PUM+J","PPSO","EXTREMADURA UNIDA","PDSJE","PCTG","PUM+J","PCPC","P-LIB","UNIDOS SÍ-A","MAS","PUM+J","PREPAL","ANDECHA","MDyC","PCTE/ELAK","EB","PYLN","FE de las J","AUNACV","EB","CAnda","UNIÓN REGIO","FIA","AVANT LOS VERDES","PCTE/ELAK","ELAK/PCTE","SOLIDARIA","centrados","RISA","DPL","PCPE","IZAR","LOS VERDES","C 21","UDT",null],["abstencion","PARTIDO SOCIALISTA OBRERO ESPAÑOL","PARTIDO POPULAR","VOX","CIUDADANOS-PARTIDO DE LA CIUDADANÍA","UNIDAS PODEMOS","ESQUERRA REPUBLICANA DE CATALUNYA-SOBIRANISTES","PARTIT DELS SOCIALISTES DE CATALUNYA","UNIDAS PODEMOS","EN COMÚ PODEM-GUANYEM EL CANVI","JUNTS PER CATALUNYA-JUNTS","PARTIDO DOS SOCIALISTAS DE GALICIA-PSOE","EUZKO ALDERDI JELTZALEA-PARTIDO NACIONALISTA VASCO","UNIDAS PODEMOS-UNIDES PODEM","EUSKAL HERRIA BILDU","MÁS PAÍS-EQUO","CANDIDATURA D'UNITAT POPULAR-PER LA RUPTURA","PARTIT POPULAR/PARTIDO POPULAR","PARTIDO SOCIALISTA DE EUSKADI-EUSKADIKO EZKERRA (PSOE)","CIUTADANS-PARTIDO DE LA CIUDADANÍA","PARTIDO ANIMALISTA CONTRA EL MALTRATO ANIMAL","EN COMÚN-UNIDAS PODEMOS","ELKARREKIN PODEMOS-UNIDAS PODEMOS","MÉS COMPROMÍS","PARTIDO POPULAR-FORO","BLOQUE NACIONALISTA GALEGO","NAVARRA SUMA","UNIDAS PODEMOS-XUNÍES PODEMOS","UNIDAS PODEMOS-UNIDES PODEM","COALICIÓN CANARIA-NUEVA CANARIAS","PARTIDO REGIONALISTA DE CANTABRIA","PARTIDO DOS SOCIALISTAS DE GALICIA-PSOE","MÁS PAÍS-ANDALUCÍA","UNIDAS PODEMOS","NUEVA CANARIAS-COALICIÓN CANARIA","MÁS PAÍS","PARTIT ANIMALISTA CONTRA EL MALTRACTAMENT ANIMAL","RECORTES CERO-GRUPO VERDE","MÁS PAÍS-CHUNTA ARAGONESISTA-EQUO","POR UN MUNDO MÁS JUSTO","AGRUPACIÓN DE ELECTORES TERUEL EXISTE","MÉS ESQUERRA","PARTIDO POPULAR / PARTIT POPULAR","ANDALUCÍA POR SÍ","UNIDAS PODEMOS-ALTOARAGÓN EN COMÚN","GEROA BAI","MÁS PAÍS","UNIÓN DEL PUEBLO LEONÉS","PARTIDO COMUNISTA OBRERO ESPAÑOL","RECORTES CERO-GRUPO VERDE-PARTIDO CASTELLANO-TIERRA COMUNERA","COALICIÓN POR MELILLA","MÁS PAÍS-CANDIDATURA ECOLOGISTA","PARTIDO COMUNISTA DE LOS TRABAJADORES DE ESPAÑA","PARTIDO COMUNISTA DE LOS PUEBLOS DE ESPAÑA","ESQUERRA REPUBLICANA DEL PAÍS VALENCIÀ","POR ÁVILA","ESCAÑOS EN BLANCO","PARTIDO COMUNISTA DEL PUEBLO ANDALUZ","LOS VERDES","PARTIDO HUMANISTA","INICIATIVA FEMINISTA","AVANT ADELANTE LOS VERDES","PER UN MÓN MÉS JUST","SOM VALENCIANS EN MOVIMENT","SOMOS REGIÓN","IZQUIERDA EN POSITIVO","LOS VERDES ECOPACIFISTAS ADELANTE","PARTIT COMUNISTA DELS TREBALLADORS DE CATALUNYA","PARTIT COMUNISTA DEL POBLE DE CATALUNYA","AHORA CANARIAS: Alternativa Nacionalista Canaria (ANC) y Unidad del Pueblo","CONTIGO SOMOS DEMOCRACIA","CHUNTA ARAGONESISTA","POR UN MUNDO MÁIS XUSTO/POR UN MUNDO MÁS JUSTO","PLATAFORMA DEL PUEBLO SORIANO","EXTREMADURA UNIDA","PARTIDO DEMÓCRATA SOCIAL JUBILADOS EUROPEOS","PARTIDO COMUNISTA DOS TRABALLADORES DE GALIZA","BIDEZKO MUNDURANTZ-POR UN MUNDO MÁS JUSTO","PARTIDO COMUNISTA DEL PUEBLO CANARIO","PARTIDO LIBERTARIO","UNIDOS Actuando por la Democracia","MOVIMIENTO ARAGONES SOCIAL","POR UN MUNDO MÁS JUSTO/BIDEZKO MUNDURANTZ","PARTIDO REGIONALISTA DEL PAÍS LEONÉS","ANDECHA ASTUR","MOVIMIENTO POR LA DIGNIDAD Y LA CIUDADANÍA DE CEUT","PARTIDO COMUNISTA DE LOS TRABAJADORES DE EUSKADI/EUSKADIKO LANGILEEN ALDERDI KOMUNISTA","ESCANOS EN BRANCO","PUYALON","FALANGE ESPAÑOLA DE LAS JONS","AUNA COMUNITAT VALENCIANA","ESCAÑOS EN BLANCO-AULKI ZURIAK","CONVERGENCIA ANDALUZA","UNIÓN REGIONALISTA DE CASTILLA Y LEÓN","FEDERACIÓN DE LOS INDEPENDIENTES DE ARAGÓN","AVANT ADELANTE LOS VERDES","PARTIDO COMUNISTA DE LOS TRABAJADORES DE ESPAÑA/ES","EUSKADIKO LANGILEEN ALDERDI KOMUNISTA/PARTIDO COMUNISTA DE LOS TRABAJADORES DE EUSKADI","PARTIDO DE ACCIÓN SOLIDARIA EUROPEA","CENTRADOS","PARTIDO REPUBLICANO INDEPENDIENTE SOLIDARIO ANDALUZ","DEMOCRACIA PLURAL","PARTIT COMUNISTA DELS POBLES D'ESPANYA","IZQUIERDA ANTICAPITALISTA REVOLUCIONARIA","LOS VERDES","CONVERXENCIA 21","UNIÓN DE TODOS",null],[10973466,5275792,4636409,3640377,1421024,1049984,869786,790413,555946,546327,526796,403267,377502,337714,276535,262177,244932,239166,225950,216317,191649,186315,181465,175016,128713,119597,98450,88393,81971,76019,68580,56892,55841,55191,47959,41548,34532,24997,22989,20629,19701,18209,17334,13914,13873,12622,10605,10178,9661,8977,8927,8455,8094,6762,5816,5399,4657,3392,3142,3089,2968,2616,2381,2315,2305,2295,2273,2205,2121,2016,1984,1980,1505,1451,1317,1250,1200,1197,1184,1156,1065,1063,910,908,870,819,693,681,623,608,578,559,515,514,456,392,378,272,262,233,229,210,190,112,99,64,26,null],[34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481,34870481],[0.314692131720236,0.151296794558125,0.132960855917072,0.104397097361519,0.0407514883433928,0.0301109697913258,0.0249433324421306,0.0226671091803982,0.0159431698117385,0.015667320447917,0.015107219197808,0.0115647099906652,0.0108258328871345,0.00968481048483386,0.00793034658741874,0.00751859430903749,0.00702404994069339,0.00685869518117631,0.0064796926661264,0.0062034418165898,0.00549602398659198,0.0053430579291407,0.00520397180641127,0.00501903027950776,0.00369117363193241,0.00342974907630325,0.00282330490365189,0.00253489477245811,0.00235072753943371,0.00218003875541608,0.00196670645294511,0.00163152323594274,0.00160138312975952,0.00158274272155867,0.0013753466721609,0.00119149489219836,0.000990293193833489,0.000716852744302552,0.000659268221737463,0.000591589201192837,0.000564976433792238,0.000522189527583517,0.000497096670390064,0.000399019445702513,0.000397843666108305,0.000361968049709438,0.000304125429184645,0.00029188011487424,0.000277053820966794,0.000257438376029284,0.000256004498475372,0.000242468694366447,0.000232116098427206,0.000193917600391001,0.000166788637070994,0.000154830098271372,0.000133551355371324,9.72742532573611e-05,9.01048654878033e-05,8.8584955280657e-05,8.5114971600191e-05,7.50204736206535e-05,6.82812491172691e-05,6.63885307461059e-05,6.61017552353235e-05,6.58149797245412e-05,6.51840736008201e-05,6.32340001275004e-05,6.08250858369289e-05,5.78139429737146e-05,5.68962613392112e-05,5.67815511348983e-05,4.31597143727384e-05,4.16111266145139e-05,3.77683347700308e-05,3.58469388477893e-05,3.44130612938778e-05,3.43270286406431e-05,3.39542204766261e-05,3.31512490464356e-05,3.05415918983165e-05,3.04842367961601e-05,2.60965714811906e-05,2.60392163790342e-05,2.49494694380614e-05,2.34869143330716e-05,1.98735428972144e-05,1.95294122842756e-05,1.78661143217382e-05,1.74359510555647e-05,1.65756245232178e-05,1.60307510527314e-05,1.47689388052892e-05,1.4740261254211e-05,1.30769632916735e-05,1.12416000226667e-05,1.08401143075715e-05,7.80029389327896e-06,7.51351838249665e-06,6.68186940122793e-06,6.56715919691501e-06,6.02228572642861e-06,5.44873470486398e-06,3.21188572076192e-06,2.83907755674492e-06,1.83536326900681e-06,7.45616328034018e-07,null]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>codigo_partido<\/th>\n      <th>siglas<\/th>\n      <th>denominacion<\/th>\n      <th>votos<\/th>\n      <th>censo_ine<\/th>\n      <th>prop_voto<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[4,5,6]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p>Como las siglas de los partidos en la info oficial y las que vienen en la encuesta no están normalizadas, me construí una tabla de “lookup” para eso.</p>
<pre class="r"><code>siglas_infoelectoral &lt;- read_csv(&quot;/home/jose/Rstudio_projects/raking_ejemplo/siglas_infoelectoral.csv&quot;)</code></pre>
<pre><code>## Rows: 92 Columns: 2</code></pre>
<pre><code>## ── Column specification ────────────────────────────────────────────────────────
## Delimiter: &quot;,&quot;
## chr (2): siglas, key</code></pre>
<pre><code>## 
## ℹ Use `spec()` to retrieve the full column specification for this data.
## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
<pre class="r"><code>DT::datatable(siglas_infoelectoral)</code></pre>
<div id="htmlwidget-2" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-2">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50","51","52","53","54","55","56","57","58","59","60","61","62","63","64","65","66","67","68","69","70","71","72","73","74","75","76","77","78","79","80","81","82","83","84","85","86","87","88","89","90","91","92"],["abstencion","PSOE","PP","VOX","Cs","PODEMOS-IU","ERC-SOBIRANISTES","PSC-PSOE","PODEMOS-IU LV CA","ECP-GUANYEM","JxCAT-JUNTS","PSdeG-PSOE","EAJ-PNV","PODEMOS-EUPV","EH Bildu","MÁS PAÍS-EQ","CUP-PR","PSE-EE (PSOE)","PACMA","PODEMOS-EU","MÉS COMPROM","PP-FORO","BNG","NA+","PODEMOS-IX","PODEMOS-EUIB","CCa-PNC-NC","PRC","MÁS PAÍS-AN","PODEMOS-IU-BATZARRE","NC-CCa-PNC","MÁS PAÍS","RECORTES CERO-GV","M PAÍS-CHA-","PUM+J","¡TERUEL EXI","MÉS-ESQUERR","AxSÍ","PODEMOS-IU-","GBAI","M PAÍS","UPL","PCOE","RECORTES CERO-GV-PCAS-TC","CpM","MÁS PAÍS-CA","PCTE","PCPE","ERPV","XAV","EB","PCPA","VERDES","PH","I.Fem","AVANT ADELANTE LOS VERDES","UIG-SOM-CUIDES","SOMOS REGIÓ","IZQP","PCTC","PCPC","AHORA CANARIAS","CONTIGO","CHA","PPSO","EXTREMADURA UNIDA","PDSJE","PCTG","P-LIB","UNIDOS SÍ-A","MAS","PREPAL","ANDECHA","MDyC","PCTE/ELAK","PYLN","FE de las J","AUNACV","CAnda","UNIÓN REGIO","FIA","AVANT LOS VERDES","ELAK/PCTE","SOLIDARIA","centrados","RISA","DPL","IZAR","LOS VERDES","C 21","UDT",null],["abstencion","PSOE","PP","VOX","CIUDADANOS","PODEMOS-IU","ERC","PSOE","PODEMOS-IU","OTROS","JXCAT","PSOE","PNV","PODEMOS-IU","BILDU","MAS PAIS","CUP","PSOE","PACMA","PODEMOS-IU","COMPROMIS","PP","BNG","OTROS","PODEMOS-IU","PODEMOS-IU","OTROS","OTROS","MAS PAIS","PODEMOS-IU","OTROS","MAS PAIS","OTROS","MAS PAIS","OTROS","OTROS","OTROS","OTROS","PODEMOS-IU","OTROS","MAS PAIS","OTROS","OTROS","OTROS","OTROS","MAS PAIS","OTROS","OTROS","OTROS","OTROS","OTROS","OTROS","OTROS","OTROS","OTROS","OTROS","OTROS","OTROS","OTROS","OTROS","OTROS","OTROS","OTROS","OTROS","OTROS","OTROS","OTROS","OTROS","OTROS","OTROS","OTROS","OTROS","OTROS","OTROS","OTROS","OTROS","OTROS","OTROS","OTROS","OTROS","OTROS","OTROS","OTROS","OTROS","OTROS","OTROS","OTROS","OTROS","OTROS","OTROS","OTROS","OTROS"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>siglas<\/th>\n      <th>key<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"order":[],"autoWidth":false,"orderClasses":false,"columnDefs":[{"orderable":false,"targets":0}]}},"evals":[],"jsHooks":[]}</script>
<pre class="r"><code>(votos_final_summary &lt;- votos_final %&gt;% 
  left_join(siglas_infoelectoral) %&gt;% 
  group_by(key) %&gt;% 
  summarise(prop_voto = sum(prop_voto, na.rm=TRUE)))</code></pre>
<pre><code>## Joining, by = &quot;siglas&quot;</code></pre>
<pre><code>## # A tibble: 16 × 2
##    key        prop_voto
##    &lt;chr&gt;          &lt;dbl&gt;
##  1 abstencion   0.315  
##  2 BILDU        0.00793
##  3 BNG          0.00343
##  4 CIUDADANOS   0.0470 
##  5 COMPROMIS    0.00502
##  6 CUP          0.00702
##  7 ERC          0.0249 
##  8 JXCAT        0.0151 
##  9 MAS PAIS     0.0115 
## 10 OTROS        0.0309 
## 11 PACMA        0.00649
## 12 PNV          0.0108 
## 13 PODEMOS-IU   0.0732 
## 14 PP           0.144  
## 15 PSOE         0.194  
## 16 VOX          0.104</code></pre>
<pre class="r"><code>votos_final_summary$key &lt;- as.factor(votos_final_summary$key)

(pop_revoto &lt;-  votos_final_summary %&gt;% 
  mutate(Freq = prop_voto * sum(df$peso)) %&gt;% 
  select(key, Freq ) )</code></pre>
<pre><code>## # A tibble: 16 × 2
##    key          Freq
##    &lt;fct&gt;       &lt;dbl&gt;
##  1 abstencion 1189. 
##  2 BILDU        30.0
##  3 BNG          13.0
##  4 CIUDADANOS  177. 
##  5 COMPROMIS    19.0
##  6 CUP          26.5
##  7 ERC          94.3
##  8 JXCAT        57.1
##  9 MAS PAIS     43.5
## 10 OTROS       117. 
## 11 PACMA        24.5
## 12 PNV          40.9
## 13 PODEMOS-IU  276. 
## 14 PP          544. 
## 15 PSOE        732. 
## 16 VOX         395.</code></pre>
<p>Y vemos que no coincide mucho con la que hay en la encuesta</p>
<pre class="r"><code>df %&gt;% 
  group_by(key) %&gt;% 
  summarise(Freq = sum(peso))</code></pre>
<pre><code>## # A tibble: 16 × 2
##    key          Freq
##    &lt;fct&gt;       &lt;dbl&gt;
##  1 abstencion 1064. 
##  2 BILDU        21.5
##  3 BNG          23.6
##  4 CIUDADANOS  239. 
##  5 COMPROMIS    22.1
##  6 CUP          17.4
##  7 ERC          81.9
##  8 JXCAT        40.0
##  9 MAS PAIS     28.7
## 10 OTROS        62.4
## 11 PACMA        26.4
## 12 PNV          40.5
## 13 PODEMOS-IU  426. 
## 14 PP          525. 
## 15 PSOE        917. 
## 16 VOX         244.</code></pre>
<p>En la encuesta hay más personas que recuerdan haber votado al psoe que las que debería haber, así como también hay menos que recuerdan haber votado a Mas País o a Vox. Había una hipótesis por ahi que decía que el votante de derechas está infrarrepresentado en las encuestas.</p>
</div>
<div id="padrón" class="section level3">
<h3>Padrón</h3>
<p>Esto es solo un csv con la info de población por sexo y edad exacta (quité los menores de 18 años)</p>
<p>Leemos el csv, que lamentablemente viene en encoding de windows y con separador decimal y tal.</p>
<pre class="r"><code>padron &lt;- read_delim(
  &quot;/home/jose/Rstudio_projects/raking_ejemplo/pad_2021.csv&quot;,
  delim = &quot;;&quot;,
  escape_double = FALSE,
  locale = locale(
    date_names = &quot;es&quot;,
    decimal_mark = &quot;,&quot;,
    grouping_mark = &quot;.&quot;,
    encoding = &quot;WINDOWS-1252&quot;
  ),
  trim_ws = TRUE
)</code></pre>
<pre><code>## Rows: 166 Columns: 3</code></pre>
<pre><code>## ── Column specification ────────────────────────────────────────────────────────
## Delimiter: &quot;;&quot;
## chr (1): sexo
## dbl (1): edad</code></pre>
<pre><code>## 
## ℹ Use `spec()` to retrieve the full column specification for this data.
## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
<p>Categorizamos la edad y vemos cuales habrían sido las frecuencias de edad en la encuestas si fueran representativas de la estructura de población del padrón de 2020</p>
<pre class="r"><code>pop_edad &lt;- padron %&gt;% 
  mutate(
    gedad =
      case_when(
        edad &gt;= 100 ~ &quot;100 años y más&quot;,
        edad &gt;= 18 &amp; edad &lt;= 24 ~ &quot;18-24 años&quot;,
        edad &gt;= 25 &amp; edad &lt;= 29 ~ &quot;25-29 años&quot;,
        edad &gt;= 30 &amp; edad &lt;= 34 ~ &quot;30-34 años&quot;,
        edad &gt;= 35 &amp; edad &lt;= 39 ~ &quot;35-39 años&quot;,
        edad &gt;= 40 &amp; edad &lt;= 44 ~ &quot;40-44 años&quot;,
        edad &gt;= 45 &amp; edad &lt;= 49 ~ &quot;45-49 años&quot;,
        edad &gt;= 50 &amp; edad &lt;= 54 ~ &quot;50-54 años&quot;,
        edad &gt;= 55 &amp; edad &lt;= 59 ~ &quot;55-59 años&quot;,
        edad &gt;= 60 &amp; edad &lt;= 64 ~ &quot;60-64 años&quot;,
        edad &gt;= 65 &amp; edad &lt;= 69 ~ &quot;65-69 años&quot;,
        edad &gt;= 70 &amp; edad &lt;= 74 ~ &quot;70-74 años&quot;,
        edad &gt;= 75 &amp; edad &lt;= 79 ~ &quot;75-79 años&quot;,
        edad &gt;= 80 &amp; edad &lt;= 84 ~ &quot;80-84 años&quot;,
        edad &gt;= 85 &amp; edad &lt;= 89 ~ &quot;85-89 años&quot;,
        edad &gt;= 90 &amp; edad &lt;= 94 ~ &quot;90-94 años&quot;,
        edad &gt;= 95 &amp; edad &lt;= 99 ~ &quot;95-99 años&quot;,
        
      )
  ) %&gt;% 
  group_by(gedad) %&gt;% 
  summarise(pob = sum(total)) %&gt;% 
  ungroup() %&gt;%
  mutate(pct = pob/sum(pob)) %&gt;% 
  mutate(Freq = pct* sum(df$peso)) %&gt;% 
  select(gedad, Freq) %&gt;% 
  filter(gedad!=&quot;100 años y más&quot;)

pop_sexo &lt;-   padron %&gt;% 
  mutate(sexo = ifelse(sexo == &quot;Hombres&quot;, &quot;Hombre&quot;, &quot;Mujer&quot;)) %&gt;% 
  group_by(sexo) %&gt;% 
  summarise(pob = sum(total)) %&gt;% 
  ungroup() %&gt;%
  mutate(pct = pob/sum(pob)) %&gt;% 
  mutate(Freq = pct* sum(df$peso)) %&gt;% 
  select(sexo, Freq)

pop_sexo$sexo &lt;- as.factor(pop_sexo$sexo)

pop_edad$gedad &lt;- as.factor(pop_edad$gedad)


pop_edad</code></pre>
<pre><code>## # A tibble: 16 × 2
##    gedad       Freq
##    &lt;fct&gt;      &lt;dbl&gt;
##  1 18-24 años 352. 
##  2 25-29 años 269. 
##  3 30-34 años 213. 
##  4 35-39 años 313. 
##  5 40-44 años 377. 
##  6 45-49 años 381. 
##  7 50-54 años 356. 
##  8 55-59 años 362. 
##  9 60-64 años 286. 
## 10 65-69 años 240. 
## 11 70-74 años 191. 
## 12 75-79 años 187. 
## 13 80-84 años 123. 
## 14 85-89 años  77.9
## 15 90-94 años  41.5
## 16 95-99 años  11.1</code></pre>
<p>Y veamos si se parece a lo que hay en la encuesta</p>
<pre class="r"><code>df %&gt;% 
  group_by(gedad) %&gt;% 
  summarise(Freq = sum(peso))</code></pre>
<pre><code>## # A tibble: 16 × 2
##    gedad        Freq
##    &lt;fct&gt;       &lt;dbl&gt;
##  1 18-24 años 235.  
##  2 25-29 años 214.  
##  3 30-34 años 214.  
##  4 35-39 años 268.  
##  5 40-44 años 402.  
##  6 45-49 años 382.  
##  7 50-54 años 392.  
##  8 55-59 años 336.  
##  9 60-64 años 334.  
## 10 65-69 años 375.  
## 11 70-74 años 282.  
## 12 75-79 años 177.  
## 13 80-84 años 114.  
## 14 85-89 años  40.0 
## 15 90-94 años  12.8 
## 16 95-99 años   1.05</code></pre>
<p>Pues en la encuesta ha caído más gente joven de la que debería, cosas que pasan.</p>
</div>
</div>
<div id="raking" class="section level2">
<h2>Raking</h2>
<p>Pues ya tenemos todo para hacer el ejercicio simple de raking.</p>
<p>Importamos la librería survery, comprobamos que los niveles de las variables que vamos a considerar en el raking son los mismos en los datos de las encuestas y en los dataframes auxiliares</p>
<pre class="r"><code># Comprobamos niveles
all.equal(levels(pop_revoto$key) , levels(df$key))</code></pre>
<pre><code>## [1] TRUE</code></pre>
<pre class="r"><code>all.equal(levels(pop_edad$gedad) , levels(df$gedad))</code></pre>
<pre><code>## [1] TRUE</code></pre>
<pre class="r"><code>all.equal(levels(pop_sexo$sexo),  levels(df$sexo))</code></pre>
<pre><code>## [1] TRUE</code></pre>
<p>Construimos un diseño muestral inicial utilizando los pesos que facilita el CIS.</p>
<pre class="r"><code>library(survey)</code></pre>
<pre><code>## Loading required package: grid</code></pre>
<pre><code>## Loading required package: Matrix</code></pre>
<pre><code>## 
## Attaching package: &#39;Matrix&#39;</code></pre>
<pre><code>## The following objects are masked from &#39;package:tidyr&#39;:
## 
##     expand, pack, unpack</code></pre>
<pre><code>## Loading required package: survival</code></pre>
<pre><code>## 
## Attaching package: &#39;survey&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:graphics&#39;:
## 
##     dotchart</code></pre>
<pre class="r"><code>disenno &lt;- svydesign(id=~1, weight=~peso,data=df)</code></pre>
<p>Vemos los totales por recuerdo de voto por ejemplo, con la estimación de su error estándar</p>
<pre class="r"><code>svytotal(~key, disenno)</code></pre>
<pre><code>##                  total      SE
## keyabstencion 1064.301 28.1710
## keyBILDU        21.475  4.4926
## keyBNG          23.630  4.9128
## keyCIUDADANOS  238.593 15.1738
## keyCOMPROMIS    22.099  4.8096
## keyCUP          17.429  4.2181
## keyERC          81.939  9.0654
## keyJXCAT        39.984  6.3702
## keyMAS PAIS     28.734  5.4132
## keyOTROS        62.353  7.5990
## keyPACMA        26.359  5.2625
## keyPNV          40.515  6.4151
## keyPODEMOS-IU  425.598 19.7388
## keyPP          525.044 21.6608
## keyPSOE        917.318 26.7850
## keyVOX         244.059 15.4552</code></pre>
<p>Para hacer el raking utilizamos la funcion <code>rake</code> que toma argumentos el diseño muestral original, una lista con el nombre de las variables (en formula) en la encuesta , y una lista con los dataframes auxiliares cada uno con dos columnas, la variable que se corresponde con la de la encuesta y una columna numérica con el valor de cuántos individuos habría de haber en la muestra para que la distribución fuera igual a la de la población. Otros parámetros, serían el número de iteraciones máximas y el criterio de parada (epsilon) del procedimiento iterativo.</p>
<pre class="r"><code>ponderacion_1 &lt;- 
  rake (
  design             = disenno,
  sample.margins     = list(~gedad, ~key, ~sexo), 
  population.margins = list(pop_edad, pop_revoto, pop_sexo)
  ) </code></pre>
<p>Y ahora podemos comprobar qué tal lo ha hecho</p>
<p>Edad</p>
<pre class="r"><code>pop_edad # dist poblacional</code></pre>
<pre><code>## # A tibble: 16 × 2
##    gedad       Freq
##    &lt;fct&gt;      &lt;dbl&gt;
##  1 18-24 años 352. 
##  2 25-29 años 269. 
##  3 30-34 años 213. 
##  4 35-39 años 313. 
##  5 40-44 años 377. 
##  6 45-49 años 381. 
##  7 50-54 años 356. 
##  8 55-59 años 362. 
##  9 60-64 años 286. 
## 10 65-69 años 240. 
## 11 70-74 años 191. 
## 12 75-79 años 187. 
## 13 80-84 años 123. 
## 14 85-89 años  77.9
## 15 90-94 años  41.5
## 16 95-99 años  11.1</code></pre>
<pre class="r"><code>svytotal(~gedad, disenno) # usando ponderaciones cis</code></pre>
<pre><code>##                    total      SE
## gedad18-24 años 234.8523 15.0942
## gedad25-29 años 214.4397 14.4131
## gedad30-34 años 214.3337 14.3916
## gedad35-39 años 267.7623 16.0524
## gedad40-44 años 401.8541 19.2163
## gedad45-49 años 382.1934 18.8006
## gedad50-54 años 392.2205 19.0815
## gedad55-59 años 335.9379 17.7668
## gedad60-64 años 334.4781 17.7006
## gedad65-69 años 374.9334 18.6334
## gedad70-74 años 281.8288 16.3995
## gedad75-79 años 176.6998 13.0458
## gedad80-84 años 114.0455 10.6935
## gedad85-89 años  40.0390  6.3841
## gedad90-94 años  12.7567  3.6124
## gedad95-99 años   1.0536  1.0536</code></pre>
<pre class="r"><code>svytotal(~gedad, ponderacion_1)</code></pre>
<pre><code>##                   total     SE
## gedad18-24 años 351.958 0.0022
## gedad25-29 años 269.150 0.0022
## gedad30-34 años 213.023 0.0019
## gedad35-39 años 312.727 0.0023
## gedad40-44 años 377.061 0.0024
## gedad45-49 años 380.727 0.0024
## gedad50-54 años 355.685 0.0022
## gedad55-59 años 361.652 0.0023
## gedad60-64 años 286.424 0.0018
## gedad65-69 años 239.837 0.0016
## gedad70-74 años 190.638 0.0013
## gedad75-79 años 186.745 0.0016
## gedad80-84 años 123.233 0.0013
## gedad85-89 años  77.958 0.0010
## gedad90-94 años  41.526 0.0011
## gedad95-99 años  11.083 0.0000</code></pre>
<p>sexo</p>
<pre class="r"><code>pop_sexo</code></pre>
<pre><code>## # A tibble: 2 × 2
##   sexo    Freq
##   &lt;fct&gt;  &lt;dbl&gt;
## 1 Hombre 1889.
## 2 Mujer  1891.</code></pre>
<p>En la encuesta original hay sobrepresentacion de mujeres</p>
<pre class="r"><code>svytotal(~sexo, disenno)</code></pre>
<pre><code>##             total     SE
## sexoHombre 1820.6 31.548
## sexoMujer  1958.8 31.519</code></pre>
<pre class="r"><code>svytotal(~sexo, ponderacion_1)</code></pre>
<pre><code>##             total SE
## sexoHombre 1888.6  0
## sexoMujer  1890.8  0</code></pre>
<p>Recuerdo de voto</p>
<pre class="r"><code>pop_revoto</code></pre>
<pre><code>## # A tibble: 16 × 2
##    key          Freq
##    &lt;fct&gt;       &lt;dbl&gt;
##  1 abstencion 1189. 
##  2 BILDU        30.0
##  3 BNG          13.0
##  4 CIUDADANOS  177. 
##  5 COMPROMIS    19.0
##  6 CUP          26.5
##  7 ERC          94.3
##  8 JXCAT        57.1
##  9 MAS PAIS     43.5
## 10 OTROS       117. 
## 11 PACMA        24.5
## 12 PNV          40.9
## 13 PODEMOS-IU  276. 
## 14 PP          544. 
## 15 PSOE        732. 
## 16 VOX         395.</code></pre>
<pre class="r"><code>svytotal(~key, disenno)</code></pre>
<pre><code>##                  total      SE
## keyabstencion 1064.301 28.1710
## keyBILDU        21.475  4.4926
## keyBNG          23.630  4.9128
## keyCIUDADANOS  238.593 15.1738
## keyCOMPROMIS    22.099  4.8096
## keyCUP          17.429  4.2181
## keyERC          81.939  9.0654
## keyJXCAT        39.984  6.3702
## keyMAS PAIS     28.734  5.4132
## keyOTROS        62.353  7.5990
## keyPACMA        26.359  5.2625
## keyPNV          40.515  6.4151
## keyPODEMOS-IU  425.598 19.7388
## keyPP          525.044 21.6608
## keyPSOE        917.318 26.7850
## keyVOX         244.059 15.4552</code></pre>
<pre class="r"><code>svytotal(~key, ponderacion_1)</code></pre>
<pre><code>##                  total    SE
## keyabstencion 1189.358 5e-04
## keyBILDU        29.972 1e-04
## keyBNG          12.962 0e+00
## keyCIUDADANOS  177.463 2e-04
## keyCOMPROMIS    18.969 1e-04
## keyCUP          26.547 1e-04
## keyERC          94.271 2e-04
## keyJXCAT        57.097 1e-04
## keyMAS PAIS     43.529 1e-04
## keyOTROS       116.681 2e-04
## keyPACMA        24.515 1e-04
## keyPNV          40.915 1e-04
## keyPODEMOS-IU  276.473 2e-04
## keyPP          544.268 3e-04
## keyPSOE        731.849 4e-04
## keyVOX         394.559 4e-04</code></pre>
<p>Pues podríamos dar por buena la calibración alcanzada</p>
<p>Los pesos los podemos extraer usando la función <code>weights</code></p>
<pre class="r"><code>weights(ponderacion_1)[1:10]</code></pre>
<pre><code>##         1         2         3         4         5         6         7         8 
## 1.8324806 1.1606015 0.5372897 1.4168519 0.6115565 0.9731935 0.8024724 0.7280362 
##         9        10 
## 1.4168519 1.2670284</code></pre>
</div>
<div id="estimación-simple-de-la-intención-de-voto." class="section level2">
<h2>Estimación simple de la intención de voto.</h2>
<p>Para realizar una “buena” estimación de voto tendria que haber hecho algo más aparte del “raking”, tal vez un modelo para tener voto probable de los indecisos etcétera.</p>
<p>No obstante vamos a ver qué estimación saldría simplemente utilizando los pesos originales y los pesos calibrados.</p>
<pre class="r"><code>(estim_cis &lt;- svytotal(~intenciongr, disenno))</code></pre>
<pre><code>##                                            total      SE
## intenciongrPP                           531.4821 21.8379
## intenciongrPSOE                         745.3097 24.8698
## intenciongrCiudadanos                   111.9348 10.5990
## intenciongrMés Compromís                 23.1522  4.9224
## intenciongrERC                           61.6780  7.9014
## intenciongrJxCat                         31.7818  5.6855
## intenciongrEAJ-PNV                       39.4836  6.3334
## intenciongrEH Bildu                      13.0444  3.5539
## intenciongrCCa-NC                        10.4548  3.4812
## intenciongrNA+                            9.4790  2.4073
## intenciongrPACMA                         29.3263  5.4769
## intenciongrVOX                          320.9019 17.4761
## intenciongrCUP                           13.3279  3.6906
## intenciongrLos Verdes                     0.0000  0.0000
## intenciongrUnidas Podemos               402.1001 19.2592
## intenciongrEQUO                           0.0000  0.0000
## intenciongrPAR                            0.0000  0.0000
## intenciongrBNG                           18.4930  4.3490
## intenciongrMÉS (PSM-Entesa)               0.0000  0.0000
## intenciongrFalange Española de las JONS   0.0000  0.0000
## intenciongrEscaños en Blanco              0.0000  0.0000
## intenciongrEspaña 2000                    0.0000  0.0000
## intenciongrPartido Libertario             0.0000  0.0000
## intenciongrCHA                            0.0000  0.0000
## intenciongrRecortes Cero                  0.0000  0.0000
## intenciongrDirecte 68                     0.0000  0.0000
## intenciongrPartido Feminista de España    0.0000  0.0000
## intenciongrGeroa Bai                      0.0000  0.0000
## intenciongrBloc                           0.0000  0.0000
## intenciongrConvergència                   0.0000  0.0000
## intenciongrCompromís-Podemos-EUPV         0.0000  0.0000
## intenciongrUPyD                           0.0000  0.0000
## intenciongrPCPE                           0.0000  0.0000
## intenciongrPI                             0.0000  0.0000
## intenciongrPAYJ                           0.0000  0.0000
## intenciongrIGRE                           0.0000  0.0000
## intenciongrPRC                            3.1434  1.6474
## intenciongrUPL                            0.0000  0.0000
## intenciongrRecortes Cero-Grupo Verde      0.0000  0.0000
## intenciongrCoalición Caballas             0.0000  0.0000
## intenciongrMDyC                           0.0000  0.0000
## intenciongrCoalición por Melilla          0.0000  0.0000
## intenciongrPPL                            0.0000  0.0000
## intenciongrMás País                      60.9837  7.8825
## intenciongrPR+                            0.0000  0.0000
## intenciongrActúa                          0.0000  0.0000
## intenciongrAnova-Irmandade Nacionalista   0.0000  0.0000
## intenciongrCompromiso por Galicia         0.0000  0.0000
## intenciongrBarcelona pel Canvi            0.0000  0.0000
## intenciongrZaragoza en Común              0.0000  0.0000
## intenciongrSantiago Aberta                0.0000  0.0000
## intenciongrCNxR                           0.0000  0.0000
## intenciongrDemocracia Nacional            0.0000  0.0000
## intenciongrPoble Lliure                   0.0000  0.0000
## intenciongrPartido Humanista              0.0000  0.0000
## intenciongrSom Valencians                 0.0000  0.0000
## intenciongrConverxencia Galega            0.0000  0.0000
## intenciongrTerra Galega                   0.0000  0.0000
## intenciongrTeruel Existe                  2.1852  1.5450
## intenciongrExtremadura Unida              0.0000  0.0000
## intenciongrPP+C s                         0.0000  0.0000
## intenciongrPDeCAT                         0.0000  0.0000
## intenciongrPNC                            0.0000  0.0000
## intenciongrVoto nulo                     44.9441  6.7160
## intenciongrAdelante Sevilla               0.0000  0.0000
## intenciongrOtro partido                  74.6794  8.5264
## intenciongrEn blanco                    172.4132 13.0502
## intenciongrNo votaría                   352.4158 18.0842
## intenciongrNo sabe todavía              548.6834 21.9338
## intenciongrN.C.                         158.0310 12.4293</code></pre>
<pre class="r"><code>(estim_calibrada &lt;- svytotal(~intenciongr, ponderacion_1))</code></pre>
<pre><code>##                                            total      SE
## intenciongrPP                           566.2767 19.2580
## intenciongrPSOE                         635.4325 18.5286
## intenciongrCiudadanos                    96.7651  8.9299
## intenciongrMés Compromís                 21.7971  3.8757
## intenciongrERC                           69.4503  6.1644
## intenciongrJxCat                         43.1817  5.2533
## intenciongrEAJ-PNV                       37.1996  4.1088
## intenciongrEH Bildu                      17.3237  4.0213
## intenciongrCCa-NC                        14.3188  4.9252
## intenciongrNA+                           16.8526  4.4475
## intenciongrPACMA                         31.5831  5.6846
## intenciongrVOX                          434.0434 17.2445
## intenciongrCUP                           18.8067  4.1303
## intenciongrLos Verdes                     0.0000  0.0000
## intenciongrUnidas Podemos               302.0278 12.7507
## intenciongrEQUO                           0.0000  0.0000
## intenciongrPAR                            0.0000  0.0000
## intenciongrBNG                           11.5789  2.4683
## intenciongrMÉS (PSM-Entesa)               0.0000  0.0000
## intenciongrFalange Española de las JONS   0.0000  0.0000
## intenciongrEscaños en Blanco              0.0000  0.0000
## intenciongrEspaña 2000                    0.0000  0.0000
## intenciongrPartido Libertario             0.0000  0.0000
## intenciongrCHA                            0.0000  0.0000
## intenciongrRecortes Cero                  0.0000  0.0000
## intenciongrDirecte 68                     0.0000  0.0000
## intenciongrPartido Feminista de España    0.0000  0.0000
## intenciongrGeroa Bai                      0.0000  0.0000
## intenciongrBloc                           0.0000  0.0000
## intenciongrConvergència                   0.0000  0.0000
## intenciongrCompromís-Podemos-EUPV         0.0000  0.0000
## intenciongrUPyD                           0.0000  0.0000
## intenciongrPCPE                           0.0000  0.0000
## intenciongrPI                             0.0000  0.0000
## intenciongrPAYJ                           0.0000  0.0000
## intenciongrIGRE                           0.0000  0.0000
## intenciongrPRC                            4.1735  2.2022
## intenciongrUPL                            0.0000  0.0000
## intenciongrRecortes Cero-Grupo Verde      0.0000  0.0000
## intenciongrCoalición Caballas             0.0000  0.0000
## intenciongrMDyC                           0.0000  0.0000
## intenciongrCoalición por Melilla          0.0000  0.0000
## intenciongrPPL                            0.0000  0.0000
## intenciongrMás País                      69.1656  7.8136
## intenciongrPR+                            0.0000  0.0000
## intenciongrActúa                          0.0000  0.0000
## intenciongrAnova-Irmandade Nacionalista   0.0000  0.0000
## intenciongrCompromiso por Galicia         0.0000  0.0000
## intenciongrBarcelona pel Canvi            0.0000  0.0000
## intenciongrZaragoza en Común              0.0000  0.0000
## intenciongrSantiago Aberta                0.0000  0.0000
## intenciongrCNxR                           0.0000  0.0000
## intenciongrDemocracia Nacional            0.0000  0.0000
## intenciongrPoble Lliure                   0.0000  0.0000
## intenciongrPartido Humanista              0.0000  0.0000
## intenciongrSom Valencians                 0.0000  0.0000
## intenciongrConverxencia Galega            0.0000  0.0000
## intenciongrTerra Galega                   0.0000  0.0000
## intenciongrTeruel Existe                  3.6379  2.6304
## intenciongrExtremadura Unida              0.0000  0.0000
## intenciongrPP+C s                         0.0000  0.0000
## intenciongrPDeCAT                         0.0000  0.0000
## intenciongrPNC                            0.0000  0.0000
## intenciongrVoto nulo                     44.0260  6.7859
## intenciongrAdelante Sevilla               0.0000  0.0000
## intenciongrOtro partido                  84.9910  9.7962
## intenciongrEn blanco                    186.4136 14.3569
## intenciongrNo votaría                   376.8699 19.3696
## intenciongrNo sabe todavía              524.4669 21.7009
## intenciongrN.C.                         169.0461 13.5892</code></pre>
<p>Vamos a pintarlas. El objeto devuelto por <code>svytotal</code> no es muy manejable, pero podemos utilizar lo que devuelve el print.</p>
<pre class="r"><code>estim_simple1 &lt;- print(svytotal(~intenciongr, disenno))</code></pre>
<pre><code>##                                            total      SE
## intenciongrPP                           531.4821 21.8379
## intenciongrPSOE                         745.3097 24.8698
## intenciongrCiudadanos                   111.9348 10.5990
## intenciongrMés Compromís                 23.1522  4.9224
## intenciongrERC                           61.6780  7.9014
## intenciongrJxCat                         31.7818  5.6855
## intenciongrEAJ-PNV                       39.4836  6.3334
## intenciongrEH Bildu                      13.0444  3.5539
## intenciongrCCa-NC                        10.4548  3.4812
## intenciongrNA+                            9.4790  2.4073
## intenciongrPACMA                         29.3263  5.4769
## intenciongrVOX                          320.9019 17.4761
## intenciongrCUP                           13.3279  3.6906
## intenciongrLos Verdes                     0.0000  0.0000
## intenciongrUnidas Podemos               402.1001 19.2592
## intenciongrEQUO                           0.0000  0.0000
## intenciongrPAR                            0.0000  0.0000
## intenciongrBNG                           18.4930  4.3490
## intenciongrMÉS (PSM-Entesa)               0.0000  0.0000
## intenciongrFalange Española de las JONS   0.0000  0.0000
## intenciongrEscaños en Blanco              0.0000  0.0000
## intenciongrEspaña 2000                    0.0000  0.0000
## intenciongrPartido Libertario             0.0000  0.0000
## intenciongrCHA                            0.0000  0.0000
## intenciongrRecortes Cero                  0.0000  0.0000
## intenciongrDirecte 68                     0.0000  0.0000
## intenciongrPartido Feminista de España    0.0000  0.0000
## intenciongrGeroa Bai                      0.0000  0.0000
## intenciongrBloc                           0.0000  0.0000
## intenciongrConvergència                   0.0000  0.0000
## intenciongrCompromís-Podemos-EUPV         0.0000  0.0000
## intenciongrUPyD                           0.0000  0.0000
## intenciongrPCPE                           0.0000  0.0000
## intenciongrPI                             0.0000  0.0000
## intenciongrPAYJ                           0.0000  0.0000
## intenciongrIGRE                           0.0000  0.0000
## intenciongrPRC                            3.1434  1.6474
## intenciongrUPL                            0.0000  0.0000
## intenciongrRecortes Cero-Grupo Verde      0.0000  0.0000
## intenciongrCoalición Caballas             0.0000  0.0000
## intenciongrMDyC                           0.0000  0.0000
## intenciongrCoalición por Melilla          0.0000  0.0000
## intenciongrPPL                            0.0000  0.0000
## intenciongrMás País                      60.9837  7.8825
## intenciongrPR+                            0.0000  0.0000
## intenciongrActúa                          0.0000  0.0000
## intenciongrAnova-Irmandade Nacionalista   0.0000  0.0000
## intenciongrCompromiso por Galicia         0.0000  0.0000
## intenciongrBarcelona pel Canvi            0.0000  0.0000
## intenciongrZaragoza en Común              0.0000  0.0000
## intenciongrSantiago Aberta                0.0000  0.0000
## intenciongrCNxR                           0.0000  0.0000
## intenciongrDemocracia Nacional            0.0000  0.0000
## intenciongrPoble Lliure                   0.0000  0.0000
## intenciongrPartido Humanista              0.0000  0.0000
## intenciongrSom Valencians                 0.0000  0.0000
## intenciongrConverxencia Galega            0.0000  0.0000
## intenciongrTerra Galega                   0.0000  0.0000
## intenciongrTeruel Existe                  2.1852  1.5450
## intenciongrExtremadura Unida              0.0000  0.0000
## intenciongrPP+C s                         0.0000  0.0000
## intenciongrPDeCAT                         0.0000  0.0000
## intenciongrPNC                            0.0000  0.0000
## intenciongrVoto nulo                     44.9441  6.7160
## intenciongrAdelante Sevilla               0.0000  0.0000
## intenciongrOtro partido                  74.6794  8.5264
## intenciongrEn blanco                    172.4132 13.0502
## intenciongrNo votaría                   352.4158 18.0842
## intenciongrNo sabe todavía              548.6834 21.9338
## intenciongrN.C.                         158.0310 12.4293</code></pre>
<pre class="r"><code>estim_simple2 &lt;- print(svytotal(~intenciongr, ponderacion_1))</code></pre>
<pre><code>##                                            total      SE
## intenciongrPP                           566.2767 19.2580
## intenciongrPSOE                         635.4325 18.5286
## intenciongrCiudadanos                    96.7651  8.9299
## intenciongrMés Compromís                 21.7971  3.8757
## intenciongrERC                           69.4503  6.1644
## intenciongrJxCat                         43.1817  5.2533
## intenciongrEAJ-PNV                       37.1996  4.1088
## intenciongrEH Bildu                      17.3237  4.0213
## intenciongrCCa-NC                        14.3188  4.9252
## intenciongrNA+                           16.8526  4.4475
## intenciongrPACMA                         31.5831  5.6846
## intenciongrVOX                          434.0434 17.2445
## intenciongrCUP                           18.8067  4.1303
## intenciongrLos Verdes                     0.0000  0.0000
## intenciongrUnidas Podemos               302.0278 12.7507
## intenciongrEQUO                           0.0000  0.0000
## intenciongrPAR                            0.0000  0.0000
## intenciongrBNG                           11.5789  2.4683
## intenciongrMÉS (PSM-Entesa)               0.0000  0.0000
## intenciongrFalange Española de las JONS   0.0000  0.0000
## intenciongrEscaños en Blanco              0.0000  0.0000
## intenciongrEspaña 2000                    0.0000  0.0000
## intenciongrPartido Libertario             0.0000  0.0000
## intenciongrCHA                            0.0000  0.0000
## intenciongrRecortes Cero                  0.0000  0.0000
## intenciongrDirecte 68                     0.0000  0.0000
## intenciongrPartido Feminista de España    0.0000  0.0000
## intenciongrGeroa Bai                      0.0000  0.0000
## intenciongrBloc                           0.0000  0.0000
## intenciongrConvergència                   0.0000  0.0000
## intenciongrCompromís-Podemos-EUPV         0.0000  0.0000
## intenciongrUPyD                           0.0000  0.0000
## intenciongrPCPE                           0.0000  0.0000
## intenciongrPI                             0.0000  0.0000
## intenciongrPAYJ                           0.0000  0.0000
## intenciongrIGRE                           0.0000  0.0000
## intenciongrPRC                            4.1735  2.2022
## intenciongrUPL                            0.0000  0.0000
## intenciongrRecortes Cero-Grupo Verde      0.0000  0.0000
## intenciongrCoalición Caballas             0.0000  0.0000
## intenciongrMDyC                           0.0000  0.0000
## intenciongrCoalición por Melilla          0.0000  0.0000
## intenciongrPPL                            0.0000  0.0000
## intenciongrMás País                      69.1656  7.8136
## intenciongrPR+                            0.0000  0.0000
## intenciongrActúa                          0.0000  0.0000
## intenciongrAnova-Irmandade Nacionalista   0.0000  0.0000
## intenciongrCompromiso por Galicia         0.0000  0.0000
## intenciongrBarcelona pel Canvi            0.0000  0.0000
## intenciongrZaragoza en Común              0.0000  0.0000
## intenciongrSantiago Aberta                0.0000  0.0000
## intenciongrCNxR                           0.0000  0.0000
## intenciongrDemocracia Nacional            0.0000  0.0000
## intenciongrPoble Lliure                   0.0000  0.0000
## intenciongrPartido Humanista              0.0000  0.0000
## intenciongrSom Valencians                 0.0000  0.0000
## intenciongrConverxencia Galega            0.0000  0.0000
## intenciongrTerra Galega                   0.0000  0.0000
## intenciongrTeruel Existe                  3.6379  2.6304
## intenciongrExtremadura Unida              0.0000  0.0000
## intenciongrPP+C s                         0.0000  0.0000
## intenciongrPDeCAT                         0.0000  0.0000
## intenciongrPNC                            0.0000  0.0000
## intenciongrVoto nulo                     44.0260  6.7859
## intenciongrAdelante Sevilla               0.0000  0.0000
## intenciongrOtro partido                  84.9910  9.7962
## intenciongrEn blanco                    186.4136 14.3569
## intenciongrNo votaría                   376.8699 19.3696
## intenciongrNo sabe todavía              524.4669 21.7009
## intenciongrN.C.                         169.0461 13.5892</code></pre>
<pre class="r"><code>cis_estim &lt;- estim_simple1 %&gt;% 
  as.data.frame() %&gt;%  # as.data.frame para no perder los nombre de filas
  rownames_to_column(var = &quot;partido&quot;) %&gt;% 
  mutate(partido       = str_sub(partido, 12, -1),
         tot_low       = total - 1.96 * SE , # intervalos simples
         tot_high      = total + 1.96 * SE, 
         pct_voto      = total    / 3779.429, 
         pct_voto_low  = tot_low  / 3779.429, 
         pct_voto_high = tot_high / 3779.429
           ) 


cañi_estim &lt;- estim_simple2 %&gt;% 
  as.data.frame() %&gt;%  # as.data.frame para no perder los nombre de filas
  rownames_to_column(var = &quot;partido&quot;) %&gt;% 
  mutate(partido       = str_sub(partido, 12, -1),
         tot_low       = total - 1.96 * SE , 
         tot_high      = total + 1.96 * SE, 
         pct_voto      = total    / 3779.429, 
         pct_voto_low  = tot_low  / 3779.429, 
         pct_voto_high = tot_high / 3779.429
  ) 


p_cis &lt;- cis_estim %&gt;% 
  top_n(22, pct_voto) %&gt;% 
  ggplot(aes(y = reorder(partido, pct_voto ), x = pct_voto))  +
  geom_point(color = &quot;darkred&quot;, size = rel(3)) +
  geom_errorbarh(aes(xmin = pct_voto_low, xmax = pct_voto_high)) +
  scale_x_continuous(labels = scales::percent, 
                     limits = c(0, 0.22)) +
  labs(title = &quot;Estimación intención voto (CIS)&quot;, 
       subtitle = &quot;Usando ponderación cis&quot;,
       x = &quot;Proporción voto&quot;,
       y = &quot;Partido&quot;)
      
p_cañi &lt;- cañi_estim %&gt;% 
  top_n(22, pct_voto) %&gt;% 
  ggplot(aes(y = reorder(partido, pct_voto ), x = pct_voto))  +
  geom_point(color = &quot;darkblue&quot;, size = rel(3)) +
  geom_errorbarh(aes(xmin = pct_voto_low, xmax = pct_voto_high)) +
  scale_x_continuous(labels = scales::percent, 
                     limits = c(0, 0.22)) +
  labs(title = &quot;Estimación intención voto (con raking) &quot;, 
       subtitle = &quot;Ajustando ponderación por edad,\nsexo y recuerdo voto&quot;,
       x = &quot;Proporción voto&quot;,
       y = &quot;Partido&quot;)

p_cis + p_cañi</code></pre>
<p><img src="/post/2022-01-01-cocinando_files/figure-html/unnamed-chunk-28-1.png" width="672" /></p>
</div>
<div id="nota." class="section level2">
<h2>Nota.</h2>
<p>En vez de <code>raking</code> es usual utilizar modelos como MRP (multilevel regression and estratification), pero este último tiene el incoveniente (aunque muchas otras ventajas) de que necesita saber la distribución conjunta de las variables por las que se postestrafifica.
Aquí os dejo un <a href="https://medium.com/pew-research-center-decoded/comparing-mrp-to-raking-for-online-opt-in-polls-b05444d9931d">artículo interesante</a></p>
</div>
